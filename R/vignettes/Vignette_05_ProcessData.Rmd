---
title: "Vignette 05: Process Data"
author: "Grace Smith-Vidaurre"
date: "2023-12-27"
output: html_document
---

```{r setup, include = FALSE}

knitr::opts_chunk$set(echo = TRUE, eval = TRUE)

```

<h2>Vignette Overview and Learning Objectives</h2>

In this fourth vignette, you will write out spreadsheets of simulated detections of animal movements to your computer. You'll begin using this data in the ABISSMAL data processing and analysis workflow, including combining raw data across days and pre-processing the raw data. You will continue to use coding skills that you learned in the previous vignettes, and you will learn additional skills that include:

1. Accessing custom functions
2. Using custom functions
3. Plotting data with ggplot

<h2>Load packages and your working directory path</h2>

```{r message = FALSE, warning = FALSE}

rm(list = ls()) # Clean global environment

library(tidyverse) # Load the set of tidyverse packages
library(data.table) # Load other packages that the ABISSMAL functions require
library(ggplot2) # Load a package for making plots

# Initialize an object with the path that is your working directory
path <- "/home/gsvidaurre/Desktop/ABISSMAL_vignettes"

```

<h2>Load ABISSMAL functions</h2>

The custom R functions available through the ABISSMAL GitHub repository are stored in physical files (extension .R) inside the local repository on your computer (which you should have downloaded in vignette 01). In order to start using the ABISSMAL functions, you need to load the physical .R files so that the functions are available in your global environment. In the code below, you will use the function `source()` to load 3 of the 5 main ABISSMAL functions, plus a script that holds a set of utility functions:
```{r}

# Load the function that combines raw data
source("/home/gsvidaurre/Desktop/GitHub_repos/ABISSMAL/R/combine_raw_data.R")

# Load the function that detects perching events in the raw data
source("/home/gsvidaurre/Desktop/GitHub_repos/ABISSMAL/R/detect_perching_events.R")

# Load the function that pre-processes raw data
source("/home/gsvidaurre/Desktop/GitHub_repos/ABISSMAL/R/preprocess_detections.R")

# Load a script with utility functions that each function above requires
source("/home/gsvidaurre/Desktop/GitHub_repos/ABISSMAL/R/utilities.R")

```

<h2>Access ABISSMAL function information</h2>

After running the lines of code above, you should see that a whole set of functions have been loaded into your global environment (check the `Environment` pane). Many of these functions start with `check_`, and those are utility functions. If you scroll down, you'll see that the three main functions above (`combine_raw_data`, `detect_perching_events`, `preprocess_detections`) are all loaded in your global environment. In the column to the right of the function names you can also see a preview of each function's arguments. 

To get more information about each of these three main functions, you can click the white square icon to the very right of each function in the `Environment` pane, or run the code `View(function_name)`. This will open the script for the given function a new tab in your Source pane. In each script for each function, you'll see lines of documentation starting with the symbols "`# @". You'll see the function name and description first, and then a description of each argument (parameter) for the function. If you keep scrolling down, you'll see a section with details about how the given function works, and the information that it returns. After the lines of documentation, you'll see the code that makes up the function itself. 

<h2>Combine raw data</h2>

Once you've loaded the ABISSMAL functions, you can start using the first function, `combine_raw_data()`, to combine data collected across days per sensor into a single spreadsheet per sensor. You'll start by combining raw data for the RFID sensor collected over different days into a single spreadsheet.

Here goes more information about the arguments you are supplying to the function below:

* `sensors` is a vector containing the labels of the sensors for which you want to combine raw data. Below you're specifying RFID as a single sensor

* `path` is your general working directory

* `data_dir` is the folder that holds data inside of your working directory

* `out_dir` is the folder where you want to save the combined raw data spreadsheet. The function will create this folder if it does not already exist

* `tz` is the timezone for converting timestamps to POSIXct format. The default is "America/New York", and you can check out the "Time zones" section in the documentation for DateTimeClasses in R for more information (`?DateTimeClasses`)

* `POSIXct_format` is a string containing the POSIX formatting information for how dates and timestamps should be combined into a single column. The default is to encode the year as a 4 digit number and the month and day as 2 digit numbers, separated by dashes. The date is followed by a space, then the 2-digit hour, minute, and decimal second (separated by colons)
```{r}

combine_raw_data(sensors = "RFID", path = path, data_dir = "Data", out_dir = "Data/raw_combined", tz = "America/New York", POSIXct_format = "%Y-%m-%d %H:%M:%OS")

```

You can check that `combine_raw_data()` wrote a single spreadsheet of raw RFID data to the new directory `raw_combined`:
```{r}

list.files(file.path(path, "Data/raw_combined"), pattern = ".csv$")

```

You can read this combined .csv file (called "combined_raw_data_RFID.csv") back into R to check out the structure of this spreadsheet:
```{r}

rfid_data <- read.csv(file.path(path, "Data/raw_combined", "combined_raw_data_RFID.csv"))

glimpse(rfid_data)

```

You should be able to see that there are some new columns created by the function, such as the column `data_type`. For this spreadsheet, the columns `sensor_id` and `data_type` contain the same information, but it's useful to have separate columns to keep track of the sensor id and type of sensor used to collect data when multiple sensors are used (e.g. two beam breaker pairs will each hace a unique identifier in `sensor_id`).

The function created a new timestamps column in POSIXct format for downsteam processing and analysis, but it kept the original timestamps column. The function also added columns to indicate the stage of data processing and the date that the raw data were combined. Finally, if you check the folders with the original raw RFID data, you'll see that the original spreadsheets per day were retained and not removed not overwritten.

You can also run `combine_raw_data()` with raw data from multiple sensors by supplying a vector with the sensor labels to the argument `sensors`:
```{r}

combine_raw_data(sensors = c("RFID", "IRBB"), path = path, data_dir = "Data", out_dir = "Data/raw_combined", tz = "America/New York", POSIXct_format = "%Y-%m-%d %H:%M:%OS")

```

The RFID data will be overwritten, and you should see an additional spreadsheet with the raw IRBB data:
```{r}

list.files(file.path(path, "Data/raw_combined"), pattern = ".csv$")

```

<h2>Detect perching events</h2>

You can use the combined raw data from different sensors in subsequent ABISSMAL functions to start making behavioral inferences from events in the movement detection datasets. For instance, you can detect perching events in the raw RFID data with the function `detect_perching_events()`. You can read more about each argument in the R script that contains this function.
```{r}

detect_perching_events(file_nm = "combined_raw_data_RFID.csv", threshold = 2, run_length = 2, sensor_id_col_nm = "sensor_id", timestamps_col_nm = "timestamp_ms", PIT_tag_col_nm = "PIT_tag", rfid_label = "RFID", general_metadata_cols = c("chamber_id", "sensor_id"), path = file.path(path, "Data"), data_dir = "raw_combined", out_dir = "processed", out_file_prefix = "perching_events", tz = "America/New York", POSIXct_format = "%Y-%m-%d %H:%M:%OS")

```

`detect_perching_events()` can only operate on a single file and sensor type at a time. The function will automatically create a new folder called "processed", and will save the .csv inside of that folder with perching events (if these were detected using the temporal threshold and run length above). 

When we simulated data in the third and fourth vignettes, you simulated perching events in the RFID dataset only. Did the code above recover those perching events?
```{r}

perching <- read.csv(file.path(path, "Data", "processed", "perching_events_RFID.csv"))

glimpse(perching)

```

`detect_perching_events()` identified 4 total perching events, which is the same number that you simulated in the previous vignette. You can look at the values inside of data frame for more information about these perching events:
```{r}

# The timestamps when each perching event started
perching$perching_start

# The timestamps when each perching event ended
perching$perching_end

# The unique PIT tag identifier that tells you which individual was perched on the RFID antenna
perching$PIT_tag

```

The information above tells you that there were 2 perching events detected at 8:00 each day, and 2 perching events detected at 11:30 each day (as expected). The PIT tag for each individual was detected once each day, so there was 1 perching event performed by each individual on each day.

Detecting perching events is not a requirement in the ABISSMAL workflow, but it can be a useful step to obtain as much information from the raw data before some detections are dropped during pre-processing (see below).

<h2>Pre-process raw data</h2>

Once you've detected perching events in the raw data, you can move on to pre-processing the raw data itself with `preprocess_detections()`. The raw data can sometimes contain multiple detections separated by a short period of time (e.g. RFID detections when an individual is perching on the antenna), and these multiple detections can be a source of noise when you're trying to make behavioral inferences across data collected by multiple sensors. When the argument `mode` is set to "thin", `preprocess_detections()` removes detections separated by a very short period of time, and retains a reduced datasets of detections that still represents discrete movement events.

`preprocess_detections()` also operates on a single sensor type at a time:
```{r}

preprocess_detections(sensor = "RFID", timestamps_col_nm = "timestamp_ms", group_col_nm = "PIT_tag", mode = "thin", thin_threshold = 2, drop_tag = NULL, path = file.path(path, "Data"), data_dir = "raw_combined", out_dir = "processed", tz = "America/New York", POSIXct_format = "%Y-%m-%d %H:%M:%OS")

```

You should now see an additional .csv file called "pre_processed_data_RFID.csv" in the "processed" folder:
```{r}

list.files(file.path(path, "Data/processed"))

```

You can read this file into R to check out the data structure. You should see that there are fewer rows here compared to the spreadsheet of raw data:
```{r}

rfid_pp <- read.csv(file.path(path, "Data/processed/pre_processed_data_RFID.csv"))

glimpse(rfid_pp)

```

Next, you can pre-process the raw beam breaker data and check out the resulting .csv file:
```{r}

preprocess_detections(sensor = "IRBB", timestamps_col_nm = "timestamp_ms", group_col_nm = "sensor_id", mode = "thin", thin_threshold = 2, drop_tag = NULL, path = file.path(path, "Data"), data_dir = "raw_combined", out_dir = "processed", tz = "America/New York", POSIXct_format = "%Y-%m-%d %H:%M:%OS")

list.files(file.path(path, "Data/processed"))

irbb_pp <- read.csv(file.path(path, "Data/processed/pre_processed_data_IRBB.csv"))

glimpse(rfid_pp)

```

<h2>Plot raw and pre-processed data</h2>

Now that you've combined the raw data per sensor, detected perching events in the raw data, and pre-processed the raw data, it's time to visualize these different datasets. Making visualizations in R is important for generating high-quality figures for publications and presentations, but it's also important for checking your work as you process and analyze data.

In the code below, you'll learn how to use functions from the `ggplot2` package to make barcode style visualizations of the raw and processed detection datasets.
```{r}



```


